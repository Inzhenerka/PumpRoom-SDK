import { describe, it, expect, vi, beforeEach } from 'vitest';
import { authenticate } from '../src/auth';
import { init, getCurrentUser } from '../src/state';
import { AUTH_URL, VERIFY_URL } from '../src/constants';

beforeEach(() => {
  init({ apiKey: 'key', realm: 'test' });
  localStorage.clear();
  vi.restoreAllMocks();
});

describe('authenticate', () => {
  it('requests auth endpoint', async () => {
    const response = { uid: '1', token: 'tok', is_admin: false };
    global.fetch = vi.fn().mockResolvedValue({ ok: true, json: () => Promise.resolve(response) });

    const user = await authenticate({ login: 'l', name: 'n', istutor: false, lang: 'en', projectid: '1' });

    expect(fetch).toHaveBeenCalledWith(AUTH_URL, expect.any(Object));
    expect(user).toEqual(response);
    expect(getCurrentUser()).toEqual(response);
  });

  it('uses cached user when verified', async () => {
    const cached = { uid: '2', token: 'cached', is_admin: true };
    localStorage.setItem('pumproomUser', JSON.stringify(cached));

    const verifyResp = { is_valid: true, is_admin: true };
    global.fetch = vi.fn().mockResolvedValue({ ok: true, json: () => Promise.resolve(verifyResp) });

    const user = await authenticate({ login: 'l', name: 'n', istutor: false, lang: 'en', projectid: '1' });

    expect(fetch).toHaveBeenCalledWith(VERIFY_URL, expect.any(Object));
    expect(user).toEqual(cached);
  });
});
